<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content><title>MQTT在Android的使用 | 冷暖自知</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.4.5"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">MQTT在Android的使用</h1><a id="logo" href="/.">冷暖自知</a><p class="description">足够自律，足够自由</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">MQTT在Android的使用</h1><div class="post-meta">Aug 15, 2018<span> | </span><span class="category"><a href="/categories/Android/">Android</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 3.7k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 20</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#消息推送的方式"><span class="toc-number">1.</span> <span class="toc-text">消息推送的方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MQTT简介"><span class="toc-number">2.</span> <span class="toc-text">MQTT简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Window服务器搭建"><span class="toc-number">3.</span> <span class="toc-text">Window服务器搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Apollo"><span class="toc-number">3.1.</span> <span class="toc-text">Apollo</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#EMQX"><span class="toc-number">3.2.</span> <span class="toc-text">EMQX</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#mosquitto"><span class="toc-number">3.3.</span> <span class="toc-text">mosquitto</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Android客户端"><span class="toc-number">4.</span> <span class="toc-text">Android客户端</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#问题补充"><span class="toc-number">4.1.</span> <span class="toc-text">问题补充</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#效果"><span class="toc-number">4.2.</span> <span class="toc-text">效果</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试"><span class="toc-number">5.</span> <span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#本地测试效果"><span class="toc-number">5.1.</span> <span class="toc-text">本地测试效果</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#服务器模拟"><span class="toc-number">5.2.</span> <span class="toc-text">服务器模拟</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#模拟设备"><span class="toc-number">5.3.</span> <span class="toc-text">模拟设备</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#模拟下发"><span class="toc-number">5.4.</span> <span class="toc-text">模拟下发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#手机效果"><span class="toc-number">5.5.</span> <span class="toc-text">手机效果</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ubuntu-远程服务器测试"><span class="toc-number">5.6.</span> <span class="toc-text">ubuntu 远程服务器测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#二次改进"><span class="toc-number">6.</span> <span class="toc-text">二次改进</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#备注"><span class="toc-number">7.</span> <span class="toc-text">备注</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#摘录"><span class="toc-number">8.</span> <span class="toc-text">摘录</span></a></li></ol></div></div><div class="post-content"><h4 id="消息推送的方式"><a href="#消息推送的方式" class="headerlink" title="消息推送的方式"></a>消息推送的方式</h4><ul>
<li>轮询   <ul>
<li>Handler、定时器…</li>
</ul>
</li>
<li>持久连接： 长连接<ul>
<li>Google的C2DM（Cloudto Device Messaging）。需要科学上网，国内大多数用户无法使用。</li>
<li>XMPP<ul>
<li>XMPP(可扩展通讯和表示协议)是基于可扩展标记语言（XML）的协议。androidpn是一个基于XMPP协议的java开源Android push notification实现。它包含了完整的客户端和服务器端。</li>
</ul>
</li>
<li>MQTT<ul>
<li>MQTT是一个轻量级的消息发布/订阅协议，它是实现基于手机客户端的消息推送服务器的理想解决方案。</li>
</ul>
</li>
<li>WebSocket    </li>
</ul>
</li>
</ul>
<h4 id="MQTT简介"><a href="#MQTT简介" class="headerlink" title="MQTT简介"></a>MQTT简介</h4><ul>
<li><a href="http://mqtt.org/">MQTT官网</a></li>
<li><a href="http://www.ibm.com">MQTT介绍</a></li>
<li><a href="https://github.com/eclipse/paho.mqtt.android">MQTT Android github</a></li>
<li><a href="http://www.eclipse.org/paho/files/javadoc/index.html">MQTT API</a></li>
<li><a href="http://www.eclipse.org/paho/files/android-javadoc/index.html">MQTT Android API</a></li>
</ul>
<h4 id="Window服务器搭建"><a href="#Window服务器搭建" class="headerlink" title="Window服务器搭建"></a>Window服务器搭建</h4><h5 id="Apollo"><a href="#Apollo" class="headerlink" title="Apollo"></a>Apollo</h5><ul>
<li><p><a href="http://activemq.apache.org/apollo/download.html">点击下载 Apollo 1.7.1</a></p>
</li>
<li><p>命令行进入安装目录bin目录下  </p>
</li>
<li><p>输入apollo create XXX（xxx为创建的服务器实例名称，例：apollo create mybroker），之后会在bin目录下创建名称为XXX的文件夹。XXX文件夹下etc\apollo.xml文件下是配置服务器信息的文件。etc\users.properties文件包含连接MQTT服务器时用到的用户名和密码，默认为admin=password，即账号为admin，密码为password，可自行更改。</p>
</li>
<li><p>进入XXX/bin目录，输入apollo-broker.cmd run开启服务器，没报错一般就是开启成功</p>
</li>
<li><p>之后在浏览器输入<a href="http://127.0.0.1:61680/">http://127.0.0.1:61680/</a>，查看是否安装成功。 </p>
</li>
</ul>
<h5 id="EMQX"><a href="#EMQX" class="headerlink" title="EMQX"></a>EMQX</h5><p><a href="https://wuhansan.github.io/2019/03/07/EMQX%E9%83%A8%E7%BD%B2%E5%9C%A8Window%E7%B3%BB%E7%BB%9F/">EMQX部署在Window系统</a></p>
<h5 id="mosquitto"><a href="#mosquitto" class="headerlink" title="mosquitto"></a>mosquitto</h5><h4 id="Android客户端"><a href="#Android客户端" class="headerlink" title="Android客户端"></a>Android客户端</h4><ul>
<li><p><strong>先看到最后</strong></p>
</li>
<li><p>build.gradle (app)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">...</span><br><span class="line">	repositories &#123;</span><br><span class="line">    	maven &#123;</span><br><span class="line">        	url &quot;https://repo.eclipse.org/content/repositories/paho-releases/&quot;</span><br><span class="line">    	&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">...</span><br><span class="line">    implementation &apos;org.eclipse.paho:org.eclipse.paho.client.mqttv3:1.1.0&apos;</span><br><span class="line">    implementation &apos;org.eclipse.paho:org.eclipse.paho.android.service:1.1.0&apos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>AndroidManifest.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--权限--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.INTERNET"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.ACCESS_NETWORK_STATE"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.WAKE_LOCK"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line">        &lt;!-- Mqtt Service --&gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">service</span> <span class="attr">android:name</span>=<span class="string">"org.eclipse.paho.android.service.MqttService"</span> /&gt;</span></span><br><span class="line">		  <span class="comment">&lt;!-- 自己定义的逻辑 Service --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">service</span> <span class="attr">android:name</span>=<span class="string">".MyMtqqService"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>MyMtqqService.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMtqqService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line"><span class="comment">//    private String host = "tcp://电脑IPv4:61613";</span></span><br><span class="line"><span class="comment">//    private String clientId = "02";</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">//一般来说是 10.0.2.2但是模拟器中的IP地址网段为3，所以写的10.0.3.2</span></span><br><span class="line">    <span class="comment">//记得观察仔细</span></span><br><span class="line">    <span class="keyword">private</span> String host = <span class="string">"tcp://10.0.3.2:61613"</span>;</span><br><span class="line">    <span class="keyword">private</span> String clientId = <span class="string">"03"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String userName = <span class="string">"admin"</span>;</span><br><span class="line">    <span class="keyword">private</span> String passWord = <span class="string">"password"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String myTopic = <span class="string">"topic"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> MqttAndroidClient client;</span><br><span class="line">    <span class="keyword">private</span> MqttConnectOptions conOpt;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//初始化</span></span><br><span class="line">        init();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">//抽取出来的发送函数，供调用</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">publish</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        String topic = myTopic;</span><br><span class="line">        <span class="comment">//QOS ＝　0/1/2  　最多一次　　最少一次　多次</span></span><br><span class="line">        Integer qos = <span class="number">2</span>	;</span><br><span class="line">        <span class="comment">//是否保留消息，为ｔｒｕｅ时,后来订阅该主题的仍然收到该消息</span></span><br><span class="line">        Boolean retained = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            client.publish(topic, msg.getBytes(), qos, <span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MqttException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 服务器地址（协议+地址+端口号）</span></span><br><span class="line">        String uri = host;</span><br><span class="line">        client = <span class="keyword">new</span> MqttAndroidClient(<span class="keyword">this</span>.getApplicationContext(), uri, clientId);</span><br><span class="line">        <span class="comment">// 设置MQTT监听并且接受消息</span></span><br><span class="line">        client.setCallback(mqttCallback);</span><br><span class="line">    </span><br><span class="line">        conOpt = <span class="keyword">new</span> MqttConnectOptions();</span><br><span class="line">        <span class="comment">// 不清除缓存　为false表示服务器会保留客户端的连接记录，否则每次连接到服务器都会以新的身份接入　　　　</span></span><br><span class="line">       conOpt.setCleanSession(ｆａlse);</span><br><span class="line">        <span class="comment">// 设置超时时间，单位：秒　　这个有默认</span></span><br><span class="line">      <span class="comment">//  conOpt.setConnectionTimeout(10);</span></span><br><span class="line">        <span class="comment">// mqtt自带实现的心跳包发送间隔，单位：秒　　　这个有默认　６０</span></span><br><span class="line">        <span class="comment">//conOpt.setKeepAliveInterval(20);</span></span><br><span class="line">        <span class="comment">// 用户名</span></span><br><span class="line">        conOpt.setUserName(userName);</span><br><span class="line">        <span class="comment">// 密码</span></span><br><span class="line">        conOpt.setPassword(passWord.toCharArray());</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">boolean</span> doConnect = <span class="keyword">true</span>;</span><br><span class="line">        String message = <span class="string">"&#123;\"terminal_uid\":\""</span> + clientId + <span class="string">"掉线\"&#125;"</span>;</span><br><span class="line">        String topic = myTopic;</span><br><span class="line">        Integer qos = <span class="number">2</span>;</span><br><span class="line">        Boolean retained = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> ((!message.equals(<span class="string">""</span>)) || (!topic.equals(<span class="string">""</span>))) &#123;</span><br><span class="line">            <span class="comment">// 最后的遗嘱 也就是断线之后发送出来的消息,测试发现　收到这个消息的时候已经掉线很久</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                conOpt.setWill(topic, message.getBytes(), qos, retained);</span><br><span class="line">                LogUtils.e(<span class="string">" conOpt.setWill"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                LogUtils.e(e.toString());</span><br><span class="line">                doConnect = <span class="keyword">false</span>;</span><br><span class="line">                iMqttActionListener.onFailure(<span class="keyword">null</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (doConnect) &#123;</span><br><span class="line">            doClientConnection();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            client.disconnect();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MqttException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment">//连接MQTT服务器</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doClientConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LogUtils.e(<span class="string">"doClientConnection"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!client.isConnected() &amp;&amp; isConnectIsNomarl()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                client.connect(conOpt, <span class="keyword">null</span>, iMqttActionListener);</span><br><span class="line">                LogUtils.e(<span class="string">" client.connect"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (MqttException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                LogUtils.e(e.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// MQTT是否连接成功</span></span><br><span class="line">    <span class="keyword">private</span> IMqttActionListener iMqttActionListener = <span class="keyword">new</span> IMqttActionListener() &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(IMqttToken arg0)</span> </span>&#123;</span><br><span class="line">            LogUtils.e(<span class="string">"连接成功 "</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 订阅myTopic话题</span></span><br><span class="line">                client.subscribe(myTopic, <span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (MqttException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(IMqttToken arg0, Throwable arg1)</span> </span>&#123;</span><br><span class="line">            arg1.printStackTrace();</span><br><span class="line">            LogUtils.e(<span class="string">" 失败 "</span> + arg1.toString());</span><br><span class="line">            <span class="comment">// 连接失败，重连</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// MQTT监听并且接受消息</span></span><br><span class="line">    <span class="keyword">private</span> MqttCallback mqttCallback = <span class="keyword">new</span> MqttCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">messageArrived</span><span class="params">(String topic, MqttMessage message)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            String str1 = <span class="keyword">new</span> String(message.getPayload());</span><br><span class="line">            String str2 = topic + <span class="string">";qos:"</span> + message.getQos() + <span class="string">";retained:"</span> + message.isRetained();</span><br><span class="line">            LogUtils.e(<span class="string">"messageArrived:"</span> + str1);</span><br><span class="line">            LogUtils.e(str2);</span><br><span class="line">            Toast.makeText(MyMtqqService.<span class="keyword">this</span>, str1, Toast.LENGTH_SHORT).show();</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deliveryComplete</span><span class="params">(IMqttDeliveryToken arg0)</span> </span>&#123;</span><br><span class="line">            LogUtils.e(arg0.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connectionLost</span><span class="params">(Throwable arg0)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 失去连接，重连</span></span><br><span class="line">            <span class="comment">//先判断客户端是否为空　　然后客户端.connect（x,x）</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">     <span class="comment">// 判断网络是否连接</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isConnectIsNomarl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ConnectivityManager connectivityManager = (ConnectivityManager) <span class="keyword">this</span>.getApplicationContext().getSystemService(Context.CONNECTIVITY_SERVICE);</span><br><span class="line">        NetworkInfo info = connectivityManager.getActiveNetworkInfo();</span><br><span class="line">        <span class="keyword">if</span> (info != <span class="keyword">null</span> &amp;&amp; info.isAvailable()) &#123;</span><br><span class="line">            String name = info.getTypeName();</span><br><span class="line">            LogUtils.e(<span class="string">"MQTT当前网络名称："</span> + name);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LogUtils.e(<span class="string">"MQTT 没有可用网络"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>MainActivity.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//开启</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startMqtt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment">//判断服务是否在运行</span></span><br><span class="line">        isRunning = isServiceRunning();<span class="comment">//不贴了</span></span><br><span class="line">        <span class="keyword">if</span> (isRunning) &#123;</span><br><span class="line">          <span class="comment">// "已经开启了MQTT", clsToolBox.getDateTimeString()));</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            startService(<span class="keyword">new</span> Intent(<span class="keyword">this</span>, MQTTService<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">           <span class="comment">// "开启MQTT"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//连接</span></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">connectMqtt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        isRunning = isServiceRunning();</span><br><span class="line">        <span class="keyword">if</span> (!isRunning) &#123;</span><br><span class="line">        <span class="comment">//"请开启MQTT服务";</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (MQTTService.isConnect()) &#123;</span><br><span class="line">           <span class="comment">//"MQTT服务已经连接上了"</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            MQTTService.connect();</span><br><span class="line">           <span class="comment">//"MQTT服务开始连接"</span></span><br><span class="line">        &#125;</span><br><span class="line">   </span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//　发送消息</span></span><br><span class="line">MyMtqqService.pulish(xxx);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="问题补充"><a href="#问题补充" class="headerlink" title="问题补充"></a>问题补充</h5><ul>
<li>MqttException (0) - java.net.SocketTimeoutException: failed to connect to 192.168.x.x</li>
<li>解决方法<ul>
<li>一般测试都是在局域网内。所以一定设备和主机要在同一网段</li>
<li>防火墙！防火墙！防火墙！一定要关闭，我就是碰到这个问题</li>
</ul>
</li>
</ul>
<h5 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h5><ul>
<li>当两台同一局域网的设备安装了apk，之后，已经可以相互通讯并且接收消息了。</li>
</ul>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><h5 id="本地测试效果"><a href="#本地测试效果" class="headerlink" title="本地测试效果"></a>本地测试效果</h5><ul>
<li><h5 id="服务器模拟"><a href="#服务器模拟" class="headerlink" title="服务器模拟"></a>服务器模拟</h5><ul>
<li><strong>MQTTLens.io</strong> 谷歌插件，没法翻墙，你就直接下载插件包，然后打开谷歌浏览器的开发者模式，皆可以安装上了。当然你也可以使用 星愿浏览器，和Chrom一样，但可以直接下载安装插件</li>
</ul>
</li>
</ul>
<p><img src="%E6%A8%A1%E6%8B%9F%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8B%E5%8F%91.png" alt="模拟服务器下发"></p>
<ul>
<li><h5 id="模拟设备"><a href="#模拟设备" class="headerlink" title="模拟设备"></a>模拟设备</h5><ul>
<li><p>点击 index.html 。</p>
<ul>
<li>例如E:\apache-apollo-1.7.1\examples\mqtt\websocket\index.html</li>
</ul>
<p><img src="%E6%A8%A1%E6%8B%9F%E8%AE%BE%E5%A4%87.png" alt="模拟设备"></p>
</li>
</ul>
</li>
<li><h5 id="模拟下发"><a href="#模拟下发" class="headerlink" title="模拟下发"></a>模拟下发</h5><p><img src="%E6%A8%A1%E6%8B%9F%E4%B8%8B%E5%8F%91.png" alt="模拟下发"></p>
</li>
<li><h5 id="手机效果"><a href="#手机效果" class="headerlink" title="手机效果"></a>手机效果</h5><p><img src="%E6%89%8B%E6%9C%BA%E6%95%88%E6%9E%9C.png" alt="手机效果"></p>
</li>
</ul>
<h5 id="ubuntu-远程服务器测试"><a href="#ubuntu-远程服务器测试" class="headerlink" title="ubuntu 远程服务器测试"></a>ubuntu 远程服务器测试</h5><ul>
<li><p>订阅话题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//固定某个</span><br><span class="line">mosquitto_sub -h localhost -p xxx服务器端口 -t &quot;话题&quot; -v　-u &quot;服务器账号&quot; -P &quot;密码&quot;</span><br><span class="line">//监听一级话题下的所有话题</span><br><span class="line">mosquitto_sub -h localhost -p xxx服务器端口 -t &quot;一级话题/#&quot; -v　-u &quot;服务器账号&quot; -P &quot;密码&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>-V  -P 都是大写</li>
</ul>
</li>
<li><p>发送测试话题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mosquitto_pub -h localhost -t &quot;topic&quot; -m &quot;&#123;\&quot;action\&quot;:\&quot;relay\&quot;xxx&#125;&quot; -u &quot;mqttuser&quot; -P &quot;yunfan&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>控制台命令是需要转义部分字符</li>
</ul>
</li>
</ul>
<h4 id="二次改进"><a href="#二次改进" class="headerlink" title="二次改进"></a>二次改进</h4><p>　- MQTTService.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MQTTService</span> <span class="keyword">extends</span> <span class="title">Service</span> <span class="keyword">implements</span> <span class="title">MqttCallbackExtended</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEBUG_TAG = <span class="string">"MQTTService"</span>; <span class="comment">// Debug TAG</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MQTT_THREAD_NAME = <span class="string">"MQTTService["</span> + DEBUG_TAG + <span class="string">"]"</span>; <span class="comment">// Handler Thread ID</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String MQTT_BROKER; <span class="comment">// Broker URL or IP Address</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String MQTT_PORT; <span class="comment">// Broker Port</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String MQTT_USE_NAME; <span class="comment">// Broker NAME</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String MQTT_PWD; <span class="comment">// Broker PWD</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String MQTT_TOPIC; <span class="comment">// Broker TOPIC</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MQTT_QOS_0 = <span class="number">0</span>; <span class="comment">// QOS Level 0 ( Delivery Once no confirmation )</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MQTT_QOS_1 = <span class="number">1</span>; <span class="comment">// QOS Level 1 ( Delevery at least Once with confirmation )</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MQTT_QOS_2 = <span class="number">2</span>; <span class="comment">// QOS Level 2 ( Delivery only once with confirmation with handshake )</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MQTT_KEEP_ALIVE = <span class="number">1000</span> * <span class="number">30</span>; <span class="comment">// KeepAlive Interval in MS  修改成30s一次</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] MQTT_KEEP_ALIVE_MESSAGE = &#123;<span class="number">0</span>&#125;; <span class="comment">// Keep Alive message to send</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MQTT_KEEP_ALIVE_QOS = MQTT_QOS_2; <span class="comment">// Default Keepalive QOS</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> MQTT_CLEAN_SESSION = <span class="keyword">true</span>; <span class="comment">// Start a clean session?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MQTT_URL_FORMAT = <span class="string">"tcp://%s:%s"</span>; <span class="comment">// URL Format normally don't change</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTION_START = DEBUG_TAG + <span class="string">".START"</span>; <span class="comment">// Action to start</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTION_STOP = DEBUG_TAG + <span class="string">".STOP"</span>; <span class="comment">// Action to stop</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTION_KEEPALIVE = DEBUG_TAG + <span class="string">".KEEPALIVE"</span>; <span class="comment">// Action to keep alive used by alarm manager</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTION_RECONNECT = DEBUG_TAG + <span class="string">".RECONNECT"</span>; <span class="comment">// Action to reconnect</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEVICE_ID_FORMAT = <span class="string">"andr_%s"</span>; <span class="comment">// Device ID Format, add any prefix you'd like</span></span><br><span class="line">    <span class="comment">// Note: There is a 23 character limit you will get</span></span><br><span class="line">    <span class="comment">// An NPE if you go over that limit</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> mStarted = <span class="keyword">false</span>;   <span class="comment">// Is the Client started?</span></span><br><span class="line">    <span class="comment">//    private String CLIENT_ID;       // Device ID, Secure.ANDROID_ID</span></span><br><span class="line">    <span class="keyword">private</span> Handler mConnHandler;     <span class="comment">// Seperate Handler thread for networking</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MemoryPersistence mMemStore; <span class="comment">// On Fail reverts to MemoryStore</span></span><br><span class="line">    <span class="keyword">private</span> MqttConnectOptions mOpts; <span class="comment">// Connection Options</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressLint</span>(<span class="string">"StaticFieldLeak"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> MqttAndroidClient mClient; <span class="comment">// Mqtt Client</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AlarmManager mAlarmManager; <span class="comment">// Alarm manager to perform repeating tasks</span></span><br><span class="line">    <span class="keyword">private</span> ConnectivityManager mConnectivityManager; <span class="comment">// To check for connectivity changes</span></span><br><span class="line">    <span class="keyword">private</span> Gson gson;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> MqttBean mqttBean;</span><br><span class="line">    <span class="keyword">private</span> MqttMessage mPublisMessage;</span><br><span class="line">    <span class="keyword">private</span> MqttMessage message;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> MQTTService instance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MQTTService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> MQTTService <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> MQTTService();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Start MQTT Client</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx context to start the service with</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">actionStart</span><span class="params">(Context ctx)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        LogUtils.e(<span class="string">"actionStart"</span>);</span><br><span class="line"></span><br><span class="line">        Intent i = <span class="keyword">new</span> Intent(ctx, MQTTService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        i.setAction(ACTION_START);</span><br><span class="line">        ctx.startService(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Stop MQTT Client</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx context to start the service with</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">actionStop</span><span class="params">(Context ctx)</span> </span>&#123;</span><br><span class="line">        Intent i = <span class="keyword">new</span> Intent(ctx, MQTTService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        i.setAction(ACTION_STOP);</span><br><span class="line">        ctx.startService(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Send a KeepAlive Message</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx context to start the service with</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">actionKeepalive</span><span class="params">(Context ctx)</span> </span>&#123;</span><br><span class="line">        Intent i = <span class="keyword">new</span> Intent(ctx, MQTTService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        i.setAction(ACTION_KEEPALIVE);</span><br><span class="line">        ctx.startService(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">actionReconnect</span><span class="params">(Context ctx)</span> </span>&#123;</span><br><span class="line">        Intent i = <span class="keyword">new</span> Intent(ctx, MQTTService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        i.setAction(ACTION_RECONNECT);</span><br><span class="line">        ctx.startService(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initalizes the DeviceId and most instance variables</span></span><br><span class="line"><span class="comment">     * Including the Connection Handler, Datastore, Alarm Manager</span></span><br><span class="line"><span class="comment">     * and ConnectivityManager.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressLint</span>(<span class="string">"HardwareIds"</span>)</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        LogUtils.e(<span class="string">"onCreate"</span>);</span><br><span class="line"></span><br><span class="line">        gson = <span class="keyword">new</span> Gson();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        HandlerThread thread = <span class="keyword">new</span> HandlerThread(MQTT_THREAD_NAME);</span><br><span class="line">        thread.start();</span><br><span class="line">        mConnHandler = <span class="keyword">new</span> Handler(thread.getLooper());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定时心跳 以及变化监听</span></span><br><span class="line">        mAlarmManager = (AlarmManager) getSystemService(ALARM_SERVICE);</span><br><span class="line">        mConnectivityManager = (ConnectivityManager) getSystemService(CONNECTIVITY_SERVICE);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        CLIENT_ID = ACache.get(MyApplication.getInstance()).getAsString(<span class="string">"imei"</span>);</span><br><span class="line">        LogUtils.e(TextUtils.isEmpty(CLIENT_ID) ? <span class="string">"null"</span> : CLIENT_ID);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initOption</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        mOpts = <span class="keyword">new</span> MqttConnectOptions();</span><br><span class="line">        mOpts.setUserName(MQTT_USE_NAME);</span><br><span class="line">        mOpts.setPassword(MQTT_PWD.toCharArray());</span><br><span class="line">        mOpts.setAutomaticReconnect(<span class="keyword">true</span>);</span><br><span class="line">        mOpts.setKeepAliveInterval(<span class="number">30</span>);</span><br><span class="line">        mOpts.setConnectionTimeout(<span class="number">60</span>);</span><br><span class="line">        mOpts.setCleanSession(MQTT_CLEAN_SESSION);</span><br><span class="line"></span><br><span class="line">        mOpts.setWill(<span class="string">"zhineng-"</span> + MQTT_TOPIC, (CLIENT_ID + <span class="string">" 发布了遗嘱 "</span>).getBytes(), MQTT_QOS_0, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        mOpts.setMqttVersion(MqttConnectOptions.MQTT_VERSION_3_1_1);<span class="comment">//据说不设置这个会有EOFException</span></span><br><span class="line"></span><br><span class="line">        LogUtils.e(<span class="string">" initOption "</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Service onStartCommand</span></span><br><span class="line"><span class="comment">     * Handles the action passed via the Intent</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> START_REDELIVER_INTENT</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line"></span><br><span class="line">        String action = intent.getAction();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (action == <span class="keyword">null</span>) &#123;</span><br><span class="line">            LogToFileUtils.write(<span class="string">" Starting service with  and no action\n Probably from a crash"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">                <span class="keyword">case</span> ACTION_START:</span><br><span class="line">                    LogUtils.e(<span class="string">"Received ACTION_START"</span>);</span><br><span class="line"></span><br><span class="line">                    String str = ACache.get(<span class="keyword">this</span>).getAsString(<span class="string">"bean"</span>);</span><br><span class="line">                    mqttBean = <span class="keyword">new</span> Gson().fromJson(str, MqttBean<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                    MQTT_BROKER = mqttBean.getServer();</span><br><span class="line">                    MQTT_PORT = mqttBean.getPort();</span><br><span class="line">                    MQTT_USE_NAME = mqttBean.getUserName();</span><br><span class="line">                    MQTT_PWD = mqttBean.getPwd();</span><br><span class="line">                    MQTT_TOPIC = mqttBean.getTopic();</span><br><span class="line"></span><br><span class="line">                    start();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ACTION_STOP:</span><br><span class="line">                    LogUtils.e(<span class="string">"Received ACTION_STOP"</span>);</span><br><span class="line">                    stop();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ACTION_KEEPALIVE:</span><br><span class="line">                    LogUtils.w(<span class="string">"Received ACTION_KEEPALIVE"</span>);</span><br><span class="line">                    keepAlive();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ACTION_RECONNECT:</span><br><span class="line"></span><br><span class="line">                    LogUtils.e(<span class="string">"Received ACTION_RECONNECT"</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (isNetworkAvailable()) &#123;</span><br><span class="line">                        reconnectIfNecessary();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        LogToFileUtils.write(<span class="string">"网络故障 无法重连 "</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> START_REDELIVER_INTENT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Attempts connect to the Mqtt Broker</span></span><br><span class="line"><span class="comment">     * and listen for Connectivity changes</span></span><br><span class="line"><span class="comment">     * via ConnectivityManager.CONNECTVITIY_ACTION BroadcastReceiver</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mStarted) &#123;</span><br><span class="line">            LogUtils.e(<span class="string">"Attempt to start while already started"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hasScheduledKeepAlives()) &#123;</span><br><span class="line"></span><br><span class="line">            LogToFileUtils.write(<span class="string">"start方法中  hasScheduledKeepAlives   执行  stopKeepAlives"</span>);</span><br><span class="line">            stopKeepAlives();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        connect();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Attempts to stop the Mqtt client</span></span><br><span class="line"><span class="comment">     * as well as halting all keep alive messages queued</span></span><br><span class="line"><span class="comment">     * in the alarm manager</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LogToFileUtils.write(<span class="string">" MQTTService  stop()  "</span>);</span><br><span class="line">        <span class="keyword">if</span> (!mStarted) &#123;</span><br><span class="line">            LogToFileUtils.write(<span class="string">"Attemtpign to stop connection that isn't running"</span>);</span><br><span class="line">            LogUtils.e(<span class="string">"Attemtpign to stop connection that isn't running"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != mClient) &#123;</span><br><span class="line">            mConnHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (isConnect() ) &#123;</span><br><span class="line">                            mClient.disconnect();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (MqttException ex) &#123;</span><br><span class="line">                        ex.printStackTrace();</span><br><span class="line">                        LogToFileUtils.write(<span class="string">"STOP 方法异常"</span> + CommonUtils.getStackTrace(ex));</span><br><span class="line">                    &#125;</span><br><span class="line">                    LogToFileUtils.write(<span class="string">" mqtt stop"</span>);</span><br><span class="line"></span><br><span class="line">                    mClient = <span class="keyword">null</span>;</span><br><span class="line">                    mStarted = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Connects to the broker with the appropriate datastore</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        initOption();</span><br><span class="line"></span><br><span class="line">        String url = String.format(Locale.US, MQTT_URL_FORMAT, MQTT_BROKER, MQTT_PORT);</span><br><span class="line">        mClient = <span class="keyword">new</span> MqttAndroidClient(<span class="keyword">this</span>, url, CLIENT_ID);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        LogUtils.e(<span class="string">"Connecting with URL: "</span> + url);</span><br><span class="line">        LogToFileUtils.write(<span class="keyword">null</span> == MQTT_TOPIC ? <span class="string">"null==MQTT_TOPIC"</span> : MQTT_TOPIC);</span><br><span class="line">        LogUtils.e(<span class="keyword">null</span> == mClient ? <span class="string">"null==mClient"</span> : <span class="string">"null!=mClient"</span>);</span><br><span class="line"></span><br><span class="line">        mConnHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                LogUtils.e(<span class="string">"mClient is notConnect ,execute  the method --&gt; mClient.connect()    "</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    mClient.connect(mOpts, <span class="keyword">null</span>, <span class="keyword">new</span> IMqttActionListener() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(IMqttToken asyncActionToken)</span> </span>&#123;</span><br><span class="line"><span class="comment">//                                //连接成功之后设置连接断开的缓冲配置</span></span><br><span class="line"><span class="comment">//                                DisconnectedBufferOptions disconnectedBufferOptions = new DisconnectedBufferOptions();</span></span><br><span class="line"><span class="comment">//                                //开启</span></span><br><span class="line"><span class="comment">//                                disconnectedBufferOptions.setBufferEnabled(true);</span></span><br><span class="line"><span class="comment">//                                //离线后最多缓存100条</span></span><br><span class="line"><span class="comment">//                                disconnectedBufferOptions.setBufferSize(100);</span></span><br><span class="line"><span class="comment">//                                //一直持续留存</span></span><br><span class="line"><span class="comment">//                                disconnectedBufferOptions.setPersistBuffer(false);</span></span><br><span class="line"><span class="comment">//                                //删除旧消息</span></span><br><span class="line"><span class="comment">//                                disconnectedBufferOptions.setDeleteOldestMessages(false);</span></span><br><span class="line"><span class="comment">//                                if (null != mClient) &#123;</span></span><br><span class="line"><span class="comment">//                                    mClient.setBufferOpts(disconnectedBufferOptions);</span></span><br><span class="line"><span class="comment">//                                &#125;</span></span><br><span class="line">                            subscribeToTopic();</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(IMqttToken asyncActionToken, Throwable exception)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                            LogUtils.e(asyncActionToken.isComplete() + <span class="string">"  onFailure "</span> + exception.toString());</span><br><span class="line">                            LogToFileUtils.write(<span class="string">"\n\n onFailure   "</span> + asyncActionToken.isComplete() + <span class="string">"      "</span> + CommonUtils.getStackTrace(exception));</span><br><span class="line">                            <span class="keyword">if</span> (NetUtil.getInstance().isConnectIsNormal()) &#123;</span><br><span class="line">                                String s = NetUtil.getInstance().beginPing();</span><br><span class="line">                                LogToFileUtils.write(<span class="string">"\n ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^"</span>);</span><br><span class="line">                                LogToFileUtils.write(<span class="string">"onFailure   but net is normal  ,ping is "</span> + s);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                LogToFileUtils.write(<span class="string">"\n onFailure  无网络"</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    mClient.setCallback(MQTTService.<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">                    mStarted = <span class="keyword">true</span>; <span class="comment">// Service is now connected</span></span><br><span class="line"></span><br><span class="line">                    Toast.makeText(MQTTService.<span class="keyword">this</span>, <span class="string">"设备上线"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line"></span><br><span class="line">                    LogUtils.e(<span class="string">"Successfully connected and subscribed starting keep alives"</span>);</span><br><span class="line">                    LogToFileUtils.write(<span class="string">" ------  连接成功 开始心跳 Successfully connected and subscribed starting keep alives  ------"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//                    EventBus.getDefault().post(new MQTTMessage("------  连接成功 开始心跳 Successfully connected and subscribed starting keep alives  -----"));</span></span><br><span class="line"></span><br><span class="line">                    startKeepAlives();</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (MqttException e) &#123;</span><br><span class="line">                    LogToFileUtils.write(<span class="string">"connect mConnHandler post方法中  catch  MqttException  "</span> + e.getMessage());</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">subscribeToTopic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isConnect())</span><br><span class="line">                mClient.subscribe(MQTT_TOPIC, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">new</span> IMqttActionListener() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(IMqttToken asyncActionToken)</span> </span>&#123;</span><br><span class="line">                        LogToFileUtils.write(<span class="string">"订阅话题成功"</span>);</span><br><span class="line">                        LogUtils.e(<span class="string">"订阅话题成功"</span>);</span><br><span class="line"><span class="comment">//                    EventBus.getDefault().post(new MQTTMessage("订阅话题成功"));</span></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(IMqttToken asyncActionToken, Throwable exception)</span> </span>&#123;</span><br><span class="line">                        LogToFileUtils.write(<span class="string">"订阅话题失败"</span>);</span><br><span class="line">                        LogUtils.e(<span class="string">"订阅话题失败"</span>);</span><br><span class="line"><span class="comment">//                    EventBus.getDefault().post(new MQTTMessage("订阅话题失败"));</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (MqttException ex) &#123;</span><br><span class="line">            System.err.println(<span class="string">"Exception whilst subscribing"</span>);</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedules keep alives via a PendingIntent</span></span><br><span class="line"><span class="comment">     * in the Alarm Manager</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressLint</span>(<span class="string">"ShortAlarm"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startKeepAlives</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        LogUtils.d(<span class="string">" startKeepAlives "</span>);</span><br><span class="line"></span><br><span class="line">        LogToFileUtils.write(<span class="string">" startKeepAlives "</span>);</span><br><span class="line"></span><br><span class="line">        Intent i = <span class="keyword">new</span> Intent();</span><br><span class="line">        i.setClass(<span class="keyword">this</span>, MQTTService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        i.setAction(ACTION_KEEPALIVE);</span><br><span class="line">        PendingIntent pi = PendingIntent.getService(<span class="keyword">this</span>, <span class="number">0</span>, i, <span class="number">0</span>);</span><br><span class="line">        mAlarmManager.setRepeating(AlarmManager.RTC_WAKEUP,</span><br><span class="line">                System.currentTimeMillis() + MQTT_KEEP_ALIVE, MQTT_KEEP_ALIVE, pi);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Cancels the Pending Intent</span></span><br><span class="line"><span class="comment">     * in the alarm manager</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stopKeepAlives</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LogUtils.e(<span class="string">" stopKeepAlives "</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//停止</span></span><br><span class="line">        actionStop(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        LogToFileUtils.write(<span class="string">"stopKeepAlives"</span>);</span><br><span class="line"></span><br><span class="line">        Intent i = <span class="keyword">new</span> Intent();</span><br><span class="line">        i.setClass(<span class="keyword">this</span>, MQTTService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        i.setAction(ACTION_KEEPALIVE);</span><br><span class="line">        PendingIntent pi = PendingIntent.getService(<span class="keyword">this</span>, <span class="number">0</span>, i, <span class="number">0</span>);</span><br><span class="line">        mAlarmManager.cancel(pi);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Publishes a KeepALive to the topic</span></span><br><span class="line"><span class="comment">     * in the broker</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">keepAlive</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        LogUtils.d(<span class="string">"keepAlive"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isConnect()) &#123;</span><br><span class="line">            MachineBean machineBean = <span class="keyword">new</span> MachineBean(<span class="string">"net"</span>, CLIENT_ID, <span class="string">""</span> + MY_SIGNAL_STRENGTH, <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">            publish(gson.toJson(machineBean), <span class="string">"zhineng-"</span> + MQTT_TOPIC);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            actionReconnect(<span class="keyword">this</span>);</span><br><span class="line"><span class="comment">//            LogToFileUtils.write("keepAlive  isConnected ==false , so execute  actionStart");</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Checkes the current connectivity</span></span><br><span class="line"><span class="comment">     * and reconnects if it is required.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">reconnectIfNecessary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mStarted &amp;&amp; <span class="keyword">null</span> == mClient) &#123;</span><br><span class="line"></span><br><span class="line">            LogToFileUtils.write(<span class="string">"reconnectIfNecessary  connect"</span>);</span><br><span class="line"></span><br><span class="line">            connect();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LogToFileUtils.write(mStarted ? <span class="string">"mStarted==true"</span> : <span class="string">"mStart==false"</span>);</span><br><span class="line">            LogToFileUtils.write(<span class="keyword">null</span> == mClient ? <span class="string">"mClient==null"</span> : <span class="string">"mClient!=null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Query's the NetworkInfo via ConnectivityManager</span></span><br><span class="line"><span class="comment">     * to return the current connected state</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> boolean true if we are connected false otherwise</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isNetworkAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        NetworkInfo info = mConnectivityManager.getActiveNetworkInfo();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> info != <span class="keyword">null</span> &amp;&amp; info.isConnected();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Verifies the client State with our local connected state</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true if its a match we are connected false if we aren't connected</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isConnect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mClient != <span class="keyword">null</span> &amp;&amp; mStarted &amp;&amp; mClient.isConnected();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断一下client是否非空</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> publishTopic</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publish</span><span class="params">(String msg, String publishTopic)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == publishTopic) &#123;</span><br><span class="line">            publishTopic = <span class="string">"zhineng-"</span> + MQTT_TOPIC;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        MqttMessage mqttMessage = <span class="keyword">new</span> MqttMessage();</span><br><span class="line">        mqttMessage.setQos(MQTT_QOS_0);</span><br><span class="line">        mqttMessage.setPayload(msg.getBytes());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isConnect()) &#123;</span><br><span class="line">                mClient.publish(publishTopic, mqttMessage, <span class="keyword">null</span>, <span class="keyword">new</span> IMqttActionListener() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(IMqttToken asyncActionToken)</span> </span>&#123;</span><br><span class="line">                        LogUtils.w(<span class="string">"发送成功"</span> + asyncActionToken.toString());</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(IMqttToken asyncActionToken, Throwable exception)</span> </span>&#123;</span><br><span class="line">                        LogUtils.e(<span class="string">"发送失败 "</span> + CommonUtils.getStackTrace(exception));</span><br><span class="line">                        LogToFileUtils.write(CommonUtils.getStackTrace(exception));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                LogToFileUtils.write(<span class="keyword">null</span> == mClient ? <span class="string">"mClient是为空"</span> : <span class="string">"mClient不为空"</span>);</span><br><span class="line">                LogToFileUtils.write(isConnect() ? <span class="string">"mClient连接"</span> : <span class="string">"mClient未连接"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (MqttException e) &#123;</span><br><span class="line">            LogToFileUtils.write(CommonUtils.getStackTrace(e));</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Query's the AlarmManager to check if there is</span></span><br><span class="line"><span class="comment">     * a keep alive currently scheduled</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true if there is currently one scheduled false otherwise</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">hasScheduledKeepAlives</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Intent i = <span class="keyword">new</span> Intent();</span><br><span class="line">        i.setClass(<span class="keyword">this</span>, MQTTService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        i.setAction(ACTION_KEEPALIVE);</span><br><span class="line">        PendingIntent pi = PendingIntent.getBroadcast(<span class="keyword">this</span>, <span class="number">0</span>, i, PendingIntent.FLAG_NO_CREATE);</span><br><span class="line">        <span class="keyword">return</span> pi != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent arg0)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Connectivity Lost from broker</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connectionLost</span><span class="params">(Throwable arg0)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Toast.makeText(MQTTService.<span class="keyword">this</span>, <span class="string">"设备离线"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line"></span><br><span class="line">        LogUtils.e(<span class="string">"------ connectionLost ------"</span>);</span><br><span class="line"></span><br><span class="line">        stopKeepAlives();</span><br><span class="line"></span><br><span class="line">        mClient = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isNetworkAvailable()) &#123;</span><br><span class="line"></span><br><span class="line">            LogToFileUtils.write(<span class="string">"\n  ------ reconnectIfNecessary ------"</span>);</span><br><span class="line"></span><br><span class="line">            reconnectIfNecessary();</span><br><span class="line"></span><br><span class="line">            LogUtils.e(<span class="string">"------ reconnectIfNecessary ------"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LogToFileUtils.write(<span class="string">"\n  ------ isNetworkAvailable false  ------"</span>);</span><br><span class="line">            LogUtils.e(<span class="string">"------ isNetworkAvailable false ------"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Received Message from broker</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">messageArrived</span><span class="params">(String topic, MqttMessage message)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String str1 = <span class="keyword">new</span> String(message.getPayload());</span><br><span class="line">        String str2 = <span class="string">"topic:"</span> + topic + <span class="string">", qos:"</span> + message.getQos() + <span class="string">", retained:"</span> + message.isRetained();</span><br><span class="line">        LogUtils.e(<span class="string">"messageArrived:"</span> + str1);</span><br><span class="line"></span><br><span class="line">        LogToFileUtils.write(<span class="string">"--- messageArrived ---\n"</span> + str1 + <span class="string">"\n"</span> + str2 + <span class="string">"\n"</span>);</span><br><span class="line"></span><br><span class="line">        EventBus.getDefault().post(<span class="keyword">new</span> MQTTMessage(str1));</span><br><span class="line">        LogUtils.d(str2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deliveryComplete</span><span class="params">(IMqttDeliveryToken token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            LogUtils.i(<span class="string">"     发送成功    "</span> + token.isComplete() + <span class="string">" "</span> + token.getMessage().toString());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MqttException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connectComplete</span><span class="params">(<span class="keyword">boolean</span> reconnect, String serverURI)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (reconnect) &#123;</span><br><span class="line">            LogToFileUtils.write(<span class="string">"is Reconnected to : "</span> + serverURI);</span><br><span class="line">            LogUtils.e(<span class="string">"Reconnected to : "</span> + serverURI);</span><br><span class="line">            <span class="comment">// Because Clean Session is true, we need to re-subscribe</span></span><br><span class="line"><span class="comment">//            EventBus.getDefault().post(new MQTTMessage("is Reconnected to : " + serverURI));</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LogToFileUtils.write(<span class="string">"not Reconnected to  "</span>);</span><br><span class="line">            LogUtils.e(<span class="string">"not Reconnected to : "</span> + serverURI);</span><br><span class="line"><span class="comment">//            EventBus.getDefault().post(new MQTTMessage("not Reconnected to : " + serverURI));</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLowMemory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onLowMemory();</span><br><span class="line">        LogToFileUtils.write(<span class="string">"\n 内存不足"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        mqttBean = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>　- 使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">		<span class="comment">//start</span></span><br><span class="line">Intent i = <span class="keyword">new</span> Intent();</span><br><span class="line">         i.setClass(<span class="keyword">this</span>, MQTTService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">         i.setAction(ACTION_START); </span><br><span class="line">         startService(i);</span><br><span class="line"></span><br><span class="line"><span class="comment">//发送</span></span><br><span class="line">MQTTService.getInstance().publish(ｘｘｘｘ);</span><br></pre></td></tr></table></figure>

<h4 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h4><ul>
<li><a href="https://github.com/JesseFarebro/android-mqtt-service">android-mqtt-service参考案例</a></li>
</ul>
<h4 id="摘录"><a href="#摘录" class="headerlink" title="摘录"></a>摘录</h4><ul>
<li><a href="https://blog.csdn.net/qq_17250009/article/details/52774472#commentsedit">Android APP必备高级功能，消息推送之MQTT</a></li>
</ul>
</div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>冷暖自知</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/posts/63361/">https://www.wl960127.top/posts/63361/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本站内容均为个人学习笔记,不涉及商业用途，仅提供学习参考,第三方摘录已署名链接,未署名请评论添加,转载署名来源即可。</li></ul></div><br><script type="text/javascript" src="/js/share.js?v=1.4.5" async></script><a class="article-share-link" data-url="https://www.wl960127.top/posts/63361/" data-id="cku2sw7mh002bxioiwybyz3r3" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAK4AAACuCAAAAACKZ2kyAAABwklEQVR42u3aO47DMAwFwNz/0llg2yTGIynJQTCqDP80dkFIJB+PeDz/x+uZ6/OvV6/fuWzg4uKOuc/Lkbz69c5Pz14fXxtwcXHPc1chkqu9e3Bxcb+Tmwej65UJLi7uL3EXTBa8DRcX93u4yeYn2a7kn7p9r4aLizvgVhOmO4435ndxcXGL3GdxVJMayYKpMDsuLu4RbpLuTAqoSQm2t4Qq1HtxcXGXcpMp82aLZOuSXy3/Y1xc3EXceRG02nKRF2jfnMHFxT3InbdSVVMqeQBtVmtxcXEH3GpxtFf8qG6HksUQLi7uDu6O4kd+f/lf4uLiHuFWNzOrglR10YOLi3uSW22fyiebFGg/fh4uLu5N3F7LVDVsNT8JFxf3IHdZoFladHnjwcXFPcKdF056ISwJiB+fwsXF3czN260meYlJ+xcuLu5d3F7QqaZcewMXF/cubj5WhadRAxYuLu5mbjWglBcl45JML4GLi4s75ybBKwf1mjbKTRi4uLhHuNU+qFV9U+V5cXFxv4xbXR8lC5dka9QMZLi4uDdxJwmRPPzh4uLexa0mO/J0SbL5KfwUXFzcI9xewrS67ZmEMFxc3IPcP8wqvlUU9UszAAAAAElFTkSuQmCC">分享</a><div class="tags"><a href="/tags/MQTT/">MQTT</a></div><div class="post-nav"><a class="pre" href="/posts/54963/">Wii一般连接操作</a><a class="next" href="/posts/58691/">Setting添加item实现功能效果</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://www.wl960127.top/posts/63361/';
    this.page.identifier = 'posts/63361/';
    this.page.title = 'MQTT在Android的使用';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//wuwangdaren.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//wuwangdaren.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://wuwangdaren.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });
</script></div><div id="lv-container" data-id="city" data-uid="MTAyMC8zMzgyMC8xMDM3Mw=="><script>(function(d, s) {
   var j, e = d.getElementsByTagName(s)[0];
   if (typeof LivereTower === 'function') { return; }
   j = d.createElement(s);
   j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
   j.async = true;
   e.parentNode.insertBefore(j, e);
})(document, 'script');
</script></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android源码/">Android源码</a><span class="category-list-count">26</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Flutter/">Flutter</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Ubuntu/">Ubuntu</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术杂谈/">技术杂谈</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/操作系统/">操作系统</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构/">数据结构</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书笔记/">读书笔记</a><span class="category-list-count">7</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/源码/" style="font-size: 23px; color: #00d6ff">源码</a> <a href="/tags/待完成/" style="font-size: 21.33px; color: #10c5e9">待完成</a> <a href="/tags/功能实现/" style="font-size: 19.67px; color: #20b3d2">功能实现</a> <a href="/tags/binder/" style="font-size: 18px; color: #30a2bc">binder</a> <a href="/tags/MQTT/" style="font-size: 14.67px; color: #507f8f">MQTT</a> <a href="/tags/工具/" style="font-size: 14.67px; color: #507f8f">工具</a> <a href="/tags/FFmpeg/" style="font-size: 16.33px; color: #4091a6">FFmpeg</a> <a href="/tags/Flutter/" style="font-size: 13px; color: #606e79">Flutter</a> <a href="/tags/Hexo/" style="font-size: 13px; color: #606e79">Hexo</a> <a href="/tags/Jvm/" style="font-size: 16.33px; color: #4091a6">Jvm</a> <a href="/tags/Ubuntu/" style="font-size: 18px; color: #30a2bc">Ubuntu</a> <a href="/tags/WebRTC/" style="font-size: 13px; color: #606e79">WebRTC</a> <a href="/tags/Dart/" style="font-size: 13px; color: #606e79">Dart</a> <a href="/tags/Http/" style="font-size: 13px; color: #606e79">Http</a> <a href="/tags/开源框架/" style="font-size: 13px; color: #606e79">开源框架</a> <a href="/tags/内核/" style="font-size: 14.67px; color: #507f8f">内核</a> <a href="/tags/技术杂谈/" style="font-size: 16.33px; color: #4091a6">技术杂谈</a> <a href="/tags/Framework/" style="font-size: 13px; color: #606e79">Framework</a> <a href="/tags/明朝/" style="font-size: 14.67px; color: #507f8f">明朝</a> <a href="/tags/Jni/" style="font-size: 16.33px; color: #4091a6">Jni</a> <a href="/tags/知识点/" style="font-size: 14.67px; color: #507f8f">知识点</a> <a href="/tags/组件化/" style="font-size: 13px; color: #606e79">组件化</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/posts/81db0242/">知行合一王阳明</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/2b893cfe/">明朝那些事第二部分</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/95b53bcb/">关于学习的第五篇-学霸养成</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/858effef/">关于学习的第四篇-时间管理</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/cf03b6bc/">关于学习的第三篇-高度自律</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/2726a13e/">关于学习的第二篇-高效学习</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/7ae29eec/">关于学习的第一篇-底层思维</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/6f3535f0/">明朝那些事第一部分</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/de06556f/">JVM类加载机制</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/8a392f6c/">JVM基础</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://qkmin.github.io" title="某康的博客" target="_blank">某康的博客</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">冷暖自知</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.4.5" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.4.5" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=1.4.5"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" color="100,99,98" opacity="0.7" zindex="-1" count="150" src="//lib.baomitu.com/canvas-nest.js/2.0.3/canvas-nest.umd.js"></script><script type="text/javascript" id="maid-script" src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js?v=1.4.5"></script><script>if (window.mermaid) {
  var options = JSON.parse(document.getElementById('maid-script').getAttribute('mermaidoptioins'));
  mermaid.initialize(options);
}
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.4.5"></script><script type="text/javascript" src="/js/smartresize.js?v=1.4.5"></script></div></body></html>